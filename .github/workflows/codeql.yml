name: "CodeQL – Full Security & Coding-Standards"

on:
  pull_request:
    branches: [ "main", "master" ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

# ─────────────────────────────────────────────────────────────
#  ▶︎  JOB 1  ◀︎   Your existing fast PR scan (security-extended)
# ─────────────────────────────────────────────────────────────
jobs:
  security-extended:
    name: Security-Extended (fast PR scan)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - uses: actions/checkout@v4
    - uses: github/codeql-action/init@v3
      with:
        languages: c-cpp
        queries: security-extended
    - run: |
        make -j$(nproc)          # full build for extraction
    - uses: github/codeql-action/analyze@v3
      with:
        category: sec-ext
    - uses: github/codeql-action/upload-sarif@v3
      with:
        category: sec-ext

# ─────────────────────────────────────────────────────────────
#  ▶︎  JOB 2  ◀︎   Full CERT + AUTOSAR packs (may run longer)
#                tweaks: config file, SARIF artifact, packs
# ─────────────────────────────────────────────────────────────
  coding-standards:
    name: Coding-Standards (CERT + AUTOSAR)
    needs: security-extended          # run after fast scan; drop if you prefer parallel
    runs-on: ubuntu-latest            # switch to self-hosted for faster compile
    timeout-minutes: 180              # adjust if very large codebase
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Checkout CodeQL Coding Standards
      uses: actions/checkout@v4
      with:
        repository: github/codeql-coding-standards
        path: codeql-coding-standards

    # Config file lets you ignore vendor dirs etc.
    - name: Write CodeQL config
      run: |
        cat <<'YML' > .github/codeql-config.yml
        paths-ignore:
          - third_party/**
          - generated/**
        YML

    - name: Init CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        config-file: .github/codeql-config.yml
        packs: |
          github/codeql-coding-standards/cpp/cert     # full CERT pack
          github/codeql-coding-standards/cpp/autosar  # full AUTOSAR pack

    # -------- FULL BUILD (for maximum coverage) ----------
    - name: Build project
      run: |
        make -j$(nproc)              # replace with your real firmware build cmd

    # Analyze & upload SARIF
    - uses: github/codeql-action/analyze@v3
      with:
        category: coding-standards

    - name: Upload SARIF artifact
      uses: actions/upload-artifact@v4
      with:
        name: coding-standards-sarif
        path: ${{ steps.analyze.outputs.sarif-output }}
